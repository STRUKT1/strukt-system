# Airtable Mapping Documentation

This document provides a comprehensive mapping of all Airtable tables and fields used by the STRUKT backend system. Each table includes field definitions, sync directions, transformations, and conflict resolution policies.

## Table Overview

| Table | Airtable ID | Purpose | Sync Direction | Primary Use |
|-------|-------------|---------|----------------|-------------|
| Users | tbl87AICCbvbgrLCY | User profiles and onboarding data | Read/Write | Personalization, user lookup |
| Chat | tblDtOOmahkMYEqmy | Conversation history | Write/Read | AI interaction logging, memory |
| Meals | tblWLkTKkxkSEcySD | Meal logging and nutrition tracking | Write | Health data logging |
| Workouts | tblgqvIqFetN2s23J | Exercise logging and tracking | Write | Fitness data logging |
| Supplements | tblZ8F0Z8ZcMDYdej | Supplement intake tracking | Write | Health data logging |
| Sleep | tblFepeTBkng3zDSY | Sleep pattern tracking | Write | Health data logging |
| Mood | tbltkNq7OSUcu4Xpp | Mood and mental health tracking | Write | Health data logging |
| Reflections | tblDrFwiJTYGjOfEv | Daily reflection entries | Write | Mental wellness logging |

## Detailed Table Mappings

### Users Table (tbl87AICCbvbgrLCY)

**Purpose**: Stores user profiles, onboarding data, and preferences for personalization.

**Sync Direction**: Read/Write
- **Read**: User data retrieval for personalization (services/personalisationService.js)
- **Write**: Profile updates (not currently implemented)

**Key Fields**:
- Email Address (fldgyVjQJc389lqNA) - Lookup key, case-insensitive
- Full Name - User identification
- Gender Identity - Personalization context
- Pronouns - Respectful communication
- Body Type - Fitness recommendations
- Main Goal - Primary objectives (array field)
- Dietary Needs/Allergies - Nutrition constraints
- Medical Considerations - Safety context
- Preferred Coaching Tone - Communication style (array field)
- Vision of Success - Motivation context

**Transformations**:
- Email addresses are normalized to lowercase for lookups
- Array fields (Main Goal, Preferred Coaching Tone) are joined with commas for display

**Conflict Resolution**: 
- Source of truth: Airtable
- Backend reads only, no write conflicts currently

### Chat Table (tblDtOOmahkMYEqmy)

**Purpose**: Logs all AI conversation interactions for memory and analysis.

**Sync Direction**: Write (primary), Read (memory service)

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Transformation |
|---------------|-------------------|------|----------|----------------|
| Name | fldcHOwNiQlFpwuly | Single line | Yes | Auto-generated: "Chat – {timestamp}" |
| User | fldDtbxnE1PyTleqo | Linked record | Yes | User record ID array |
| Message | fldgNRKet3scJ8PIe | Long text | Yes | User's message content |
| AI_Response | fld3vU9nKXNmu6OZV | Long text | Yes | AI assistant's reply |
| Topic | fld2eLzWRUnKNR7Im | Single select | No | Defaults to "Other" |

**Transformations**:
- User field requires array format: [userId]
- Timestamps are auto-generated by Airtable (Created field)
- Topics are validated against Airtable's select options

**Conflict Resolution**: N/A (write-only from backend)

### Meals Table (tblWLkTKkxkSEcySD)

**Purpose**: Tracks meal entries with nutritional information.

**Sync Direction**: Write-only

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Default |
|---------------|-------------------|------|----------|---------|
| User | fldaTFIo8vKLoQYhS | Linked record | Yes | User record ID array |
| Description | fldLJXOsnTDqfp9mJ | Long text | Yes | Meal description |
| Calories | fldUOPuN6n39Aj1v7 | Number | No | Calorie count |
| Protein | fldbqKkHfEqmStvbn | Number | No | Protein grams |
| Carbs | fld8EvDjPVmY5vfhR | Number | No | Carbohydrate grams |
| Fats | fldLnl83bsw9ZSCka | Number | No | Fat grams |
| MealType | fldoN35qBpJ2y7OFS | Single select | No | Breakfast/Lunch/Dinner/Snack |
| MealSource | fld5DuMMbBBnYbCnS | Single select | No | "AI-Estimated" (default) |

**Transformations**:
- Numeric fields are passed as-is (no unit conversion)
- MealSource defaults to "AI-Estimated" when not provided

### Workouts Table (tblgqvIqFetN2s23J)

**Purpose**: Logs exercise sessions and fitness activities.

**Sync Direction**: Write-only

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Notes |
|---------------|-------------------|------|----------|-------|
| User | fldUuYZtmkiycOVnb | Linked record | Yes | User record ID array |
| Date | fldzVeaYTUHMxMDd9 | Date | No | Workout date |
| Type | fld9xRDtOz1mBkDQ5 | Single select | No | Exercise category |
| Description | fldKkhKomMg3Cf108 | Long text | No | Workout details |
| Duration | fldaij5HlQKv8gMcT | Number | No | Minutes |
| Calories | fld2muGFVrfM0xHmI | Number | No | Calories burned |
| Notes | fld1aEpGu5H8DWPxY | Long text | No | Additional notes |

### Supplements Table (tblZ8F0Z8ZcMDYdej)

**Purpose**: Tracks supplement intake and timing.

**Sync Direction**: Write-only

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Default |
|---------------|-------------------|------|----------|---------|
| User | fldzShNTWJornIZnP | Linked record | Yes | User record ID array |
| Date | fldQfsrapotczQaCY | Date | No | Supplement date |
| Time | fldSherUQZmn2ts73 | Single line | No | Time taken |
| SupplementName | fldad6mLDsXYMks5A | Single line | No | Supplement name |
| Notes | fldEoF1lbZoj3wPhO | Long text | No | Additional notes |
| LogType | fldzGOKvw0IF0Rbmn | Single select | No | "AI" (default) |
| Confirmed | fldiqJbsxO4yx4JvB | Checkbox | No | true (default) |

### Sleep Table (tblFepeTBkng3zDSY)

**Purpose**: Tracks sleep patterns and quality metrics.

**Sync Direction**: Write-only

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Notes |
|---------------|-------------------|------|----------|-------|
| User | fldabdr3bNgGqBawm | Linked record | Yes | User record ID array |
| Date | fldTvCL5QQ9g7fXfw | Date | No | Sleep date |
| Duration | fldt7AKiAq2qfHs89 | Number | No | Hours slept |
| Quality | fldfdd8WYqyWx6Ckc | Single select | No | Sleep quality rating |
| Bedtime | fldu544VmBsGIvEuw | Single line | No | Bedtime |
| WakeTime | fld43mo9Z09vYzoGb | Single line | No | Wake time |
| Notes | fldzLiz85up5WqPAq | Long text | No | Sleep notes |

### Mood Table (tbltkNq7OSUcu4Xpp)

**Purpose**: Tracks mood and emotional state indicators.

**Sync Direction**: Write-only

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Notes |
|---------------|-------------------|------|----------|-------|
| User | flddOxxse2QJe6DMk | Linked record | Yes | User record ID array |
| Date | fldKVcXqCXvabybIb | Date | No | Mood entry date |
| Mood | fldUpnuuJRYIBy4mL | Single select | No | Mood rating (mapped from mood.rating) |
| Notes | fldFMbuWMrBlhScua | Long text | No | Mood notes |
| Energy | fld6isxdyHYfjqsQM | Single select | No | Energy level |
| Stress | fldmLOpTwpzUc0F4Y | Single select | No | Stress level |

### Reflections Table (tblDrFwiJTYGjOfEv)

**Purpose**: Stores daily reflection and self-assessment entries.

**Sync Direction**: Write-only

**Field Mappings**:
| Backend Field | Airtable Field ID | Type | Required | Notes |
|---------------|-------------------|------|----------|-------|
| User | fldub69oCFo7ruloF | Linked record | Yes | User record ID array |
| Date | fldZibMunrMSu8iRC | Date | No | Reflection date |
| WentWell | fldYpH7CM04KeDuT4 | Long text | No | What went well |
| Challenge | fldMeD609rZU7w8pI | Long text | No | Daily challenges |
| Tomorrow | fldmDUQ8fkYCYwCUG | Long text | No | Tomorrow's focus |
| Highlight | fldmfnusmD5b4C6Dn | Long text | No | Day's highlight |

## Environment Variables

### Required Configuration

| Variable | Purpose | Format | Usage |
|----------|---------|--------|-------|
| AIRTABLE_BASE_ID | Airtable base identifier | app{12characters} | All Airtable operations |
| AIRTABLE_API_KEY | Authentication token | pat{...} or key{...} | API authorization |

### Usage Locations
- `utils/logging.js` - Main configuration
- `services/memoryService.js` - Chat history retrieval
- `services/personalisationService.js` - User data fetching
- `controllers/chatController.js` - Chat history endpoint

## Error Handling

### Standard Error Patterns
- Missing credentials: Operations fail silently (logging) or return 500 (API endpoints)
- User not found: Returns null/404 depending on context
- Airtable API errors: Logged to console, don't block application flow
- Network timeouts: Default axios timeout behavior

### Conflict Resolution Policies
- **Users Table**: Airtable is source of truth, backend reads only
- **Log Tables**: Backend writes only, no conflicts possible
- **Chat Table**: Backend writes, reads for memory; chronological order maintained

## Sync Directions Summary

| Table | Create | Read | Update | Delete | Notes |
|-------|--------|------|--------|--------|-------|
| Users | ❌ | ✅ | ❌ | ❌ | Read-only for personalization |
| Chat | ✅ | ✅ | ❌ | ❌ | Write logs, read for memory |
| Meals | ✅ | ❌ | ❌ | ❌ | Write-only logging |
| Workouts | ✅ | ❌ | ❌ | ❌ | Write-only logging |
| Supplements | ✅ | ❌ | ❌ | ❌ | Write-only logging |
| Sleep | ✅ | ❌ | ❌ | ❌ | Write-only logging |
| Mood | ✅ | ❌ | ❌ | ❌ | Write-only logging |
| Reflections | ✅ | ❌ | ❌ | ❌ | Write-only logging |

## API Endpoints Mapping

### GET /chat/history
- **Table**: Chat (tblDtOOmahkMYEqmy)
- **Fields**: All chat fields
- **Filter**: By user email
- **Sort**: Created time descending

### POST /ask
- **Table**: Chat (tblDtOOmahkMYEqmy)
- **Operation**: Create new chat record
- **Dependencies**: User lookup for personalization

### POST /log
- **Tables**: Meals, Workouts, Sleep, Mood, Supplements, Reflections
- **Operation**: Create new log record based on type
- **Routing**: Dispatched by logController based on `type` field