
> strukt-system@1.0.0 test
> node test/airtable-schema.test.js && node test/nutrition.summary.test.js && node test/profile.targets.test.js && node test/llm-pipeline.test.js && node src/tests/safetyValidator.test.js && node src/tests/openaiService.test.js && node src/tests/ask.test.js && node __tests__/toneFilterService.test.js && node __tests__/planGeneration.test.js

ğŸš€ Running Airtable Schema Tests

ğŸ§ª Testing Schema Specification...
âœ… Schema spec file exists
âœ… Schema spec file is readable and has expected structure
ğŸ‰ All schema spec tests passed!
ğŸ§ª Testing Schema Version Format...
âœ… Schema version format is correct
âœ… Backward compatibility maintained
ğŸ‰ All schema version format tests passed!
ğŸ§ª Testing Airtable Schema Adapter...
âœ… Version info loaded correctly
âœ… Table ID resolution works
âœ… Field ID resolution works
âœ… Legacy table IDs compatibility works
âœ… Legacy field IDs compatibility works
âœ… Shadow write flag accessible
âœ… Error handling for invalid table works
ğŸ‰ All adapter tests passed!
ğŸ§ª Testing Shadow Write Utilities...
âœ… Shadow writes function works
âœ… Incoming record mapping works
âœ… Shadow write flag is accessible
ğŸ‰ All shadow write tests passed!

ğŸ“Š Test Results: 4/4 test suites passed
ğŸ‰ All tests passed successfully!
ğŸš€ Running Nutrition Summary Tests

ğŸ§ª Testing Nutrition Summary Validation...
âœ… Valid query parameters pass validation
âœ… Default values work correctly
âœ… 7d range and custom timezone work
âœ… Invalid range is rejected
âœ… Unknown fields are rejected
ğŸ‰ All nutrition summary validation tests passed!

ğŸ§ª Testing Nutrition Service...
âœ… nutrition_targets extraction works
âœ… Fallback to daily_kcal_target + macro_targets works
âœ… Empty profile returns null
âœ… Null profile returns null
ğŸ‰ All nutrition service tests passed!

ğŸ§ª Testing Profile Targets Validation...
âœ… Valid nutrition targets pass validation
âœ… Invalid daily kcal target is rejected
âœ… Invalid macro values are rejected
âœ… Unknown fields in macro_targets are rejected
ğŸ‰ All profile targets validation tests passed!

ğŸ§ª Testing Meal Validation with Fiber...
âœ… Valid meal with fiber passes validation
âœ… Meal without fiber passes validation
ğŸ‰ All meal validation with fiber tests passed!

ğŸ“Š Nutrition Test Results: 4/4 test suites passed
ğŸ‰ All nutrition tests passed successfully!
ğŸš€ Running Profile Targets Tests

ğŸ§ª Testing Profile Targets Validation...
âœ… Complete nutrition targets pass validation
âœ… Minimal targets pass validation
âœ… Invalid kcal target (too low) is rejected
âœ… Invalid kcal target (too high) is rejected
âœ… Negative macro values are rejected
âœ… Unreasonably high macro values are rejected
âœ… Unknown fields in macro_targets are rejected
âœ… Invalid activity factor is rejected
ğŸ‰ All profile targets validation tests passed!

ğŸ§ª Testing Profile Targets Service...
âœ… Nutrition target fields are preserved and unknown fields removed
âœ… Null values are properly filtered out at top level
ğŸ‰ All profile targets service tests passed!

ğŸ§ª Testing Profile Update Payload...
âœ… PATCH payload with targets passes validation
âœ… Partial macro targets update passes validation
âœ… Full nutrition targets update passes validation
ğŸ‰ All profile update payload tests passed!

ğŸ“Š Profile Targets Test Results: 3/3 test suites passed
ğŸ‰ All profile targets tests passed successfully!
ğŸš€ Running LLM Pipeline Tests

ğŸ§ª Testing System Prompt Module...
âœ… Base system prompt loaded correctly
âœ… Empty context handling works
âœ… Memory context building works
âœ… Profile context building works
ğŸ§ª Testing System Prompt Injection...
âœ… System prompt injection includes all context
âœ… First message is properly formatted system prompt
ğŸ§ª Testing Memory Stitching...
âœ… Empty memory handling works
âœ… Single conversation memory works
âœ… Multiple conversation memory works
âœ… Memory integration in full prompt works
ğŸ§ª Testing Profile Context...
âœ… Empty profile handling works
âœ… Airtable-style profile context works
âœ… Supabase-style profile context works
âœ… Partial profile handling works
ğŸ‰ All LLM Pipeline tests passed!

ğŸš€ Running Safety Validator Tests

âœ… Safe response passes validation
{"timestamp":"2025-11-20T12:22:08.943Z","level":"warn","message":"Safety validation issue detected","issue":"Recommending to skip meals","excerpt":"You should skip breakfast to lose weight faster."}
âœ… Detect meal skipping advice
{"timestamp":"2025-11-20T12:22:08.945Z","level":"warn","message":"Safety validation issue detected","issue":"Advising to stop prescribed medication","excerpt":"You should stop taking your medication and try natural remedies instead."}
âœ… Detect medication advice
{"timestamp":"2025-11-20T12:22:08.945Z","level":"warn","message":"Safety validation issue detected","issue":"Attempting to diagnose medical condition","excerpt":"Based on your symptoms, you might have diabetes. Here's what to do..."}
âœ… Detect diagnosis attempts
{"timestamp":"2025-11-20T12:22:08.945Z","level":"warn","message":"Safety validation issue detected","issue":"Discouraging medical consultation","excerpt":"There's no need to see a doctor about that, just do these exercises."}
âœ… Detect discouraging medical consultation
{"timestamp":"2025-11-20T12:22:08.945Z","level":"warn","message":"Safety validation issue detected","issue":"Encouraging exercising through pain or injury","excerpt":"Just push through the pain, it will get better with time."}
âœ… Detect push through pain advice
{"timestamp":"2025-11-20T12:22:08.946Z","level":"warn","message":"Safety validation issue detected","issue":"Promoting rapid/extreme weight loss","excerpt":"You can lose 20 pounds in 2 weeks with this diet!"}
âœ… Detect extreme weight loss claims
{"timestamp":"2025-11-20T12:22:08.946Z","level":"warn","message":"Safety validation issue detected","issue":"Suggesting very low calorie intake","excerpt":"Just eat 800 calories per day and you'll see results."}
âœ… Detect very low calorie suggestions
âœ… Handle null/undefined input gracefully
âœ… Detect borderline content (good advice to see doctor)
âœ… No false positives on safe content
âœ… SAFETY_RULES has correct structure

==================================================
ğŸ“Š Test Results: 12/12 tests passed
ğŸ‰ All safety validator tests passed!
ğŸš€ Running OpenAI Service Tests

âœ… getFallbackResponse returns default message
âœ… getFallbackResponse handles timeout type
âœ… getFallbackResponse handles error type
âœ… getFallbackResponse handles unsafe type
âœ… getFallbackResponse handles unknown type gracefully
âœ… All fallback messages are user-friendly

==================================================
ğŸ“Š Test Results: 6/6 tests passed
ğŸ‰ All OpenAI service tests passed!
ğŸš€ Running Ask Controller Tests

âœ… Controller module exports askController
âœ… Validation rejects empty messages array
âœ… Validation accepts valid messages
âœ… Validation enforces 1000 character limit
âœ… Validation requires valid role
âœ… Validation accepts optional userId as UUID
âœ… Validation rejects invalid UUID format

==================================================
ğŸ“Š Test Results: 7/7 tests passed
ğŸ‰ All ask controller tests passed!
ğŸš€ Running Tone Filter Service Tests

âœ… Safe supportive response passes all checks
âœ… Encouraging response with positive tone passes
{"timestamp":"2025-11-20T12:22:09.805Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental language: using failure-oriented language","severity":"medium","excerpt":"You failed to complete your workout plan this week."}
âœ… Detects "you failed" as judgmental
{"timestamp":"2025-11-20T12:22:09.806Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental tone: accusatory questioning","severity":"medium","excerpt":"Why didn't you complete your meals yesterday?"}
âœ… Detects "why didn't you" as accusatory
{"timestamp":"2025-11-20T12:22:09.807Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental tone: past regret inducing","severity":"low","excerpt":"You should have done your workout this morning."}
âœ… Detects "should have" as regret-inducing
{"timestamp":"2025-11-20T12:22:09.807Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful language: using derogatory terms","severity":"high","excerpt":"You're being lazy about your fitness goals."}
âœ… Detects derogatory terms (lazy, weak)
{"timestamp":"2025-11-20T12:22:09.807Z","level":"warn","message":"Tone safety issue detected","issue":"Sarcastic or dismissive tone","severity":"medium","excerpt":"Yeah right, I'm sure you'll stick to your plan this time."}
âœ… Detects sarcastic tone ("yeah right")
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Passive-aggressive tone","severity":"medium","excerpt":"Good luck with that workout plan of yours."}
âœ… Detects passive-aggressive tone ("good luck with that")
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful advice: recommending meal skipping","severity":"high","excerpt":"Try to skip meals to accelerate your weight loss."}
âœ… Detects meal skipping advice
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful advice: restrictive eating","severity":"high","excerpt":"Just don't eat after 6pm and you'll lose weight."}
âœ… Detects "don't eat" restrictive advice
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful advice: promoting starvation","severity":"high","excerpt":"Starve yourself for a day to reset your metabolism."}
âœ… Detects starvation language
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful advice: encouraging ignoring pain","severity":"high","excerpt":"Just push through the pain during your workout."}
âœ… Detects "push through pain" advice
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful advice: promoting pain tolerance","severity":"medium","excerpt":"Remember, no pain, no gain! Push harder."}
âœ… Detects "no pain no gain" mentality
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Prescriptive tone: using commanding language","severity":"low","excerpt":"You must do 100 push-ups every day."}
âœ… Detects prescriptive "must do" commands
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Prescriptive tone: commanding future actions","severity":"medium","excerpt":"You will eat exactly 1500 calories per day."}
âœ… Detects "you will" commanding tone
{"timestamp":"2025-11-20T12:22:09.808Z","level":"warn","message":"Tone safety issue detected","issue":"Body-negative language: using weight-based labels","severity":"high","excerpt":"You're overweight and need to change that."}
âœ… Detects body-negative weight labels
{"timestamp":"2025-11-20T12:22:09.809Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful advice: promoting rapid weight loss","severity":"high","excerpt":"You can lose weight fast with this approach."}
âœ… Detects rapid weight loss promotion
{"timestamp":"2025-11-20T12:22:09.809Z","level":"warn","message":"Tone safety issue detected","issue":"Moral framing: assigning morality to food choices","severity":"medium","excerpt":"That cheat meal was being bad - you need to be good tomorrow."}
âœ… Detects moral food framing ("cheat meal", "being bad")
{"timestamp":"2025-11-20T12:22:09.809Z","level":"warn","message":"Tone safety issue detected","issue":"Non-inclusive language: binary gender assumptions","severity":"low","excerpt":"Tell him/her to complete their workout."}
âœ… Detects binary gender assumptions (he/she)
{"timestamp":"2025-11-20T12:22:09.809Z","level":"warn","message":"Tone safety issue detected","issue":"Non-inclusive language: gendered casual terms","severity":"low","excerpt":"Hey guys, let's crush this workout!"}
âœ… Detects gendered casual terms (guys, dude)
{"timestamp":"2025-11-20T12:22:09.809Z","level":"warn","message":"Tone safety issue detected","issue":"Emotionally insensitive: dismissing mental health concerns","severity":"high","excerpt":"Just get over it and stop worrying about your anxiety."}
âœ… Detects dismissive mental health responses
{"timestamp":"2025-11-20T12:22:09.809Z","level":"warn","message":"Tone safety issue detected","issue":"Emotionally insensitive: invalidating feelings","severity":"high","excerpt":"Your stress is all in your head, just relax."}
âœ… Detects invalidating feelings ("it's in your head")
{"timestamp":"2025-11-20T12:22:09.810Z","level":"warn","message":"Tone safety issue detected","issue":"Emotionally insensitive: commanding emotional change","severity":"high","excerpt":"Stop being sad and just focus on your goals."}
âœ… Detects commanding emotional change
{"timestamp":"2025-11-20T12:22:09.810Z","level":"warn","message":"Tone safety issue detected","issue":"Ableist language detected","severity":"high","excerpt":"That's a crazy idea for your workout plan."}
âœ… Detects ableist terms (crazy, insane)
âœ… Sentiment analysis detects positive tone
âœ… Sentiment analysis detects negative tone
âœ… Sentiment analysis handles neutral tone
âœ… Handles null input gracefully
âœ… Handles undefined input gracefully
âœ… Handles empty string input
{"timestamp":"2025-11-20T12:22:09.811Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental language: using failure-oriented language","severity":"medium","excerpt":"You failed again. Why didn't you try harder? You're lazy and this is pathetic."}
{"timestamp":"2025-11-20T12:22:09.811Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental tone: accusatory questioning","severity":"medium","excerpt":"You failed again. Why didn't you try harder? You're lazy and this is pathetic."}
{"timestamp":"2025-11-20T12:22:09.811Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful language: using derogatory terms","severity":"high","excerpt":"...u failed again. Why didn't you try harder? You're lazy and this is pathetic."}
âœ… Detects multiple tone issues in single response
âœ… TONE_SAFETY_RULES has correct structure
âœ… validateTone returns proper structure

==================================================
ğŸ“Š Test Results: 33/33 tests passed
ğŸ‰ All tone filter service tests passed!
ğŸ§ª Running Plan Generation Tests...

ğŸ“‹ Testing Plan Structure Validation...
âœ… validatePlanStructure accepts valid plan
âœ… validatePlanStructure rejects null plan
âœ… validatePlanStructure detects missing training section
âœ… validatePlanStructure detects missing nutrition section
âœ… validatePlanStructure detects empty sections
âœ… validatePlanStructure accepts string sections
âœ… validatePlanStructure rejects empty string sections

ğŸ”„ Testing Fallback Plan Generation...
âœ… generateFallbackPlan creates valid structure with minimal profile
âœ… generateFallbackPlan uses profile data when available
âœ… generateFallbackPlan handles null profile fields safely
âœ… generateFallbackPlan includes all required workout days
âœ… generateFallbackPlan includes nutrition guidelines
âœ… generateFallbackPlan includes recovery strategies

ğŸ›¡ï¸ Testing Null Field Handling...
{"timestamp":"2025-11-20T12:22:10.227Z","level":"warn","message":"Failed to build full wellness context","error":"SUPABASE_URL environment variable is required","operation":"build-wellness-context"}
âœ… buildWellnessContext handles missing user data gracefully
{"timestamp":"2025-11-20T12:22:10.228Z","level":"warn","message":"Failed to build full wellness context","error":"SUPABASE_URL environment variable is required","operation":"build-wellness-context"}
âœ… buildWellnessContext returns valid structure

ğŸ’‰ Testing Wellness Context Injection...
âœ… regenerateFromProfile includes wellness context
âœ… regenerateFromProfileWithWellness exists and is a function

ğŸ’¾ Testing Save Confirmation...
âœ… Plan save returns metadata with version

ğŸ” Testing Dev Preview Mode...
âœ… Preview mode flag is recognized

==================================================
ğŸ“Š Test Results Summary
==================================================
âœ… Passed: 19
âŒ Failed: 0

ğŸ‰ All plan generation tests passed!


> strukt-system@1.0.0 test:ai-coach-memory
> node src/tests/weeklyDigest.test.js && node src/tests/vectorSearch.test.js && node src/tests/proactiveTrigger.test.js

ğŸš€ Running Weekly Digest Tests

âœ… generateWeeklyDigest function exists
âœ… Weekly digest uses gpt-4o-mini or gpt-4-turbo
âœ… Weekly digest stores with type "weekly_summary"
âœ… Weekly digest queries last 7 days of logs
âœ… ai_coach_notes table migration exists
âœ… ai_coach_notes has proper RLS policies
âœ… Weekly digest groups logs by user
âœ… Prompt service has fetchWeeklySummaries function

==================================================
ğŸ“Š Test Results: 8/8 tests passed
ğŸ‰ All weekly digest tests passed!
ğŸš€ Running Vector Search Tests

âœ… Embedding service module exports required functions
âœ… Embedding service uses text-embedding-3-small
âœ… log_embeddings table migration exists
âœ… log_embeddings has HNSW vector index
âœ… log_embeddings has proper RLS policies
âœ… Vector search RPC function migration exists
âœ… Vector search RPC filters by user_id
âœ… Vector search has date threshold parameter
âœ… searchSimilarLogs accepts userId parameter
âœ… searchSimilarLogs defaults to 90 days back
âœ… Prompt service integrates vector search
âœ… storeLogEmbedding stores all required fields

==================================================
ğŸ“Š Test Results: 12/12 tests passed
ğŸ‰ All vector search tests passed!
ğŸš€ Running Proactive Trigger Tests

âœ… checkUserStatus function exists
âœ… checkUserStatus queries last 3 days of logs
âœ… Stress detection includes stress keywords
âœ… Stress trigger requires 2 or more stressful days
âœ… coach_notifications table migration exists
âœ… coach_notifications has proper RLS policies
âœ… Notifications use type ai_coach_proactive
âœ… checkUserStatus prevents duplicate recent notifications
âœ… Proactive message is supportive and helpful
âœ… checkUserStatus groups logs by user
âœ… coach_notifications table has read field
âœ… Users can mark notifications as read

==================================================
ğŸ“Š Test Results: 12/12 tests passed
ğŸ‰ All proactive trigger tests passed!

> strukt-system@1.0.0 test:dashboard-audit
> node __tests__/dashboardAudit.test.js

ğŸ§ª Running Dashboard Audit Tests...

ğŸ“‹ Testing Audit Service Structure...

ğŸ“ Testing Audit Log Creation...

ğŸ”’ Testing PII Sanitization...

ğŸ“Š Testing Metrics Service...
{"timestamp":"2025-11-20T12:22:31.726Z","level":"info","message":"Metrics reset"}
{"timestamp":"2025-11-20T12:22:31.726Z","level":"info","message":"Metrics reset"}
{"timestamp":"2025-11-20T12:22:31.727Z","level":"info","message":"Metrics reset"}
{"timestamp":"2025-11-20T12:22:31.727Z","level":"info","message":"Metrics reset"}

ğŸ”— Testing Correlation ID Middleware...

ğŸ”„ Testing Integration Scenarios...
âœ… dashboardAuditService exports required functions
âœ… dashboardAuditService exports required constants
âœ… sanitizeErrorMessage removes tokens
âœ… sanitizeErrorMessage removes passwords
âœ… sanitizeDataSummary removes sensitive fields
âœ… sanitizeMetadata removes authorization headers
âœ… metricsService exports required functions
âœ… recordQuery captures query metrics
âœ… recordQuery tracks errors
âœ… recordCacheHit and recordCacheMiss track cache operations
âœ… getMetrics returns valid structure
âœ… getPrometheusMetrics returns Prometheus format
âœ… getMetricsByOperation groups by operation
âœ… correlationMiddleware adds correlationId to request
âœ… correlationMiddleware generates correlationId if missing
âœ… createAuditLog requires correlationId
âœ… createAuditLog requires eventType
âœ… createAuditLog requires operation
{"timestamp":"2025-11-20T12:22:31.731Z","level":"info","message":"Dashboard audit: fetch_user_data","correlationId":"test-correlation-123","eventType":"data_fetch","status":"success","durationMs":150}
âœ… createAuditLog creates valid log entry
{"timestamp":"2025-11-20T12:22:31.732Z","level":"info","message":"Dashboard audit: integration_fetch","correlationId":"integration-test-1763641351728","eventType":"data_fetch","status":"success","durationMs":125}
âœ… complete audit workflow with all components
{"timestamp":"2025-11-20T12:22:31.732Z","level":"info","message":"Dashboard audit: fetch_dashboard_data","correlationId":"fetch-test-456","eventType":"data_fetch","status":"success","durationMs":200}
âœ… logDataFetch creates audit entry
{"timestamp":"2025-11-20T12:22:31.732Z","level":"error","message":"Dashboard audit: failed_operation","correlationId":"error-test-789","eventType":"error_response","status":"error","durationMs":null}
âœ… logErrorResponse creates audit entry with error status
{"timestamp":"2025-11-20T12:22:31.732Z","level":"error","message":"Dashboard audit: error_operation","correlationId":"error-workflow-1763641351728","eventType":"error_response","status":"error","durationMs":50}
âœ… error handling workflow

==================================================
ğŸ“Š Test Results

âœ… Passed: 23
âŒ Failed: 0

==================================================

ğŸ‰ All dashboard audit tests passed!
   Coverage: 100%

> strukt-system@1.0.0 test:cron-functions
> node __tests__/cronFunctions.test.js

ğŸ§ª Running CRON Functions Tests...

ğŸ“‹ Testing Edge Function Structure...
âœ… generateWeeklyDigest file exists
âœ… checkUserStatus file exists
âœ… generateWeeklyDigest contains retry logic
âœ… checkUserStatus contains retry logic
âœ… generateWeeklyDigest logs to system_cron_logs
âœ… checkUserStatus logs to system_cron_logs

ğŸ“‹ Testing Migration Files...
âœ… system_cron_logs migration exists
âœ… system_cron_logs migration has correct structure
âœ… coach_notifications update migration exists
âœ… coach_notifications migration adds required fields

ğŸ“‹ Testing Configuration...
âœ… config.toml exists
âœ… config.toml mentions CRON schedules

ğŸ“‹ Testing Retry Logic Pattern...
âœ… generateWeeklyDigest has correct retry delays
âœ… checkUserStatus has correct retry delays

ğŸ“‹ Testing Error Handling...
âœ… generateWeeklyDigest handles errors gracefully
âœ… checkUserStatus handles errors gracefully

==================================================
ğŸ“Š Test Results: 16/16 passed
ğŸ‰ All tests passed successfully!
ğŸš€ Running Tone Filter Integration Tests

âœ… Tone filter service exports validateTone function
âœ… Safe response passes through tone filter
{"timestamp":"2025-11-20T12:22:47.383Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful language: using derogatory terms","severity":"high","excerpt":"You're lazy and this is pathetic. Just get over it."}
{"timestamp":"2025-11-20T12:22:47.385Z","level":"warn","message":"Tone safety issue detected","issue":"Emotionally insensitive: dismissing mental health concerns","severity":"high","excerpt":"You're lazy and this is pathetic. Just get over it."}
âœ… High severity tone issues trigger fallback (as in controller)
{"timestamp":"2025-11-20T12:22:47.385Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental tone: accusatory questioning","severity":"medium","excerpt":"You should have done better. Why didn't you try harder?"}
{"timestamp":"2025-11-20T12:22:47.385Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental tone: past regret inducing","severity":"low","excerpt":"You should have done better. Why didn't you try harder?"}
âœ… Multiple medium severity issues detected
{"timestamp":"2025-11-20T12:22:47.386Z","level":"warn","message":"Tone safety issue detected","issue":"Prescriptive tone: using commanding language","severity":"low","excerpt":"You need to workout today."}
     â†’ Safe: false, Severity: low
âœ… Low severity issues do not trigger fallback
âœ… Sentiment analysis provides additional context
âœ… Handles edge cases gracefully in integration
âœ… Returns correct structure for logging to database
{"timestamp":"2025-11-20T12:22:47.386Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental language: using failure-oriented language","severity":"medium","excerpt":"You failed to meet your goals this week. Why didn't you push yourself harder? \n    You're being lazy"}
{"timestamp":"2025-11-20T12:22:47.386Z","level":"warn","message":"Tone safety issue detected","issue":"Judgmental tone: accusatory questioning","severity":"medium","excerpt":"You failed to meet your goals this week. Why didn't you push yourself harder? \n    You're being lazy"}
{"timestamp":"2025-11-20T12:22:47.386Z","level":"warn","message":"Tone safety issue detected","issue":"Harmful language: using derogatory terms","severity":"high","excerpt":"...idn't you push yourself harder? \n    You're being lazy about your fitness. Just skip breakfast an"}
âœ… Detects real-world unsafe coaching response
âœ… Allows safe, encouraging coaching response

==================================================
ğŸ“Š Integration Test Results: 10/10 tests passed
ğŸ‰ All tone filter integration tests passed!

âœ… Tone filter successfully integrated with AI coach flow
âœ… Safe responses pass through
âœ… Unsafe responses trigger fallback
âœ… Logging structure compatible with database

> strukt-system@1.0.0 test:supabase-smoke
> node test/test-supabase-smoke.js

ğŸ§ª Running Supabase Smoke Tests...

ğŸ“‹ Test 1: Environment Configuration
âœ… SUPABASE_URL is defined in .env.example
âœ… SUPABASE_SERVICE_ROLE_KEY is defined in .env.example
âœ… DATA_BACKEND_PRIMARY is defined in .env.example
âœ… DUAL_WRITE is defined in .env.example
âœ… DATA_BACKEND_PRIMARY defaults to supabase
âœ… DUAL_WRITE defaults to false

ğŸ“‹ Test 2: Module Loading (No Credentials Required)
âœ… userProfiles module loads successfully
âœ… Service defaults to supabase backend
âœ… Dual-write defaults to false

ğŸ“‹ Test 3: Service Modules Loading
âœ… workouts service module loads successfully
âœ… workouts has input sanitization function
âœ… meals service module loads successfully
âœ… meals has input sanitization function
âœ… sleep service module loads successfully
âœ… sleep has input sanitization function
âœ… supplements service module loads successfully
âœ… supplements has input sanitization function
âœ… mood service module loads successfully
âœ… mood has input sanitization function
âœ… chat service module loads successfully
âœ… chat has input sanitization function

ğŸ“‹ Test 4: Input Validation Security
âœ… Valid fields are preserved
âœ… Unknown fields are stripped for security
âœ… Null values are handled safely

ğŸ“‹ Test 5: Database Schema
âœ… Initial schema migration file exists
âœ… Schema includes user_profiles table
âœ… Schema includes workouts table
âœ… Schema includes meals table
âœ… Schema includes sleep_logs table
âœ… Schema includes supplements table
âœ… Schema includes mood_logs table
âœ… Schema includes chat_interactions table

ğŸ¯ Smoke Test Summary:
âœ… All smoke tests passed! Supabase integration is ready.

ğŸ“‹ Next Steps for Full Integration:
1. Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in your environment
2. Run the full integration test: npm run test:integration
3. Test with real credentials in a dev environment

> strukt-system@1.0.0 test:supabase-integration
> node test/test-supabase-integration.js

ğŸ§ª Testing Supabase Integration...

âœ… Supabase client module loads successfully
âœ… User Profiles service loads successfully
ğŸ“Š Service Config: {
  DATA_BACKEND_PRIMARY: 'supabase',
  DUAL_WRITE: false,
  TABLE: 'user_profiles'
}
âœ… Primary backend correctly set to Supabase
âœ… workouts service loads successfully
âœ… meals service loads successfully
âœ… sleep service loads successfully
âœ… supplements service loads successfully
âœ… mood service loads successfully
âœ… chat service loads successfully
âœ… ETL module loads successfully
ğŸ“Š Field mappings configured: 53 fields
âœ… ETL mapping function works correctly
ğŸ“ Sample mapping result: email, user_id, full_name, primary_goal, data_env

ğŸ‰ All basic integration tests completed!

ğŸ“‹ Next Steps:
1. Set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables
2. Test actual Supabase connectivity with real credentials
3. Run ETL script with real Airtable data
4. Test dual-write functionality
